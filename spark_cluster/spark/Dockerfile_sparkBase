ARG DOWNLOADS_ROOT
ARG UNPACK_ROOT
ARG INSTALL_ROOT
ARG HOST_DOWNLOADS_FOLDER
ARG HOST_INSTALL_FOLDER
ARG SPARK_ARCHIVE
ARG SPARK_UNPACK_SUBPATH

ARG SPARK_HOME

FROM coffeeblast/spark_cluster_ubuntu_base_img:latest AS build_container

ARG DOWNLOADS_ROOT
ARG UNPACK_ROOT
ARG INSTALL_ROOT
ARG HOST_DOWNLOADS_FOLDER
ARG HOST_INSTALL_FOLDER
ARG SPARK_ARCHIVE

ENV DOWNLOADS_ROOT=${DOWNLOADS_ROOT}
ENV SPARK_ARCHIVE=${SPARK_ARCHIVE}
ENV UNPACK_ROOT=${UNPACK_ROOT}

RUN mkdir ${DOWNLOADS_ROOT} ${UNPACK_ROOT} ${INSTALL_ROOT}
COPY ${HOST_INSTALL_FOLDER}/* ${INSTALL_ROOT}
COPY ${HOST_DOWNLOADS_FOLDER}/* ${DOWNLOADS_ROOT}
RUN chmod +x ${INSTALL_ROOT}prepare_files.sh && ${INSTALL_ROOT}prepare_files.sh

FROM coffeeblast/spark_cluster_ubuntu_base_img:latest as production

ARG SPARK_HOME
ARG UNPACK_ROOT
ARG SPARK_UNPACK_SUBPATH

ENV SPARK_HOME=${SPARK_HOME}
RUN mkdir ${SPARK_HOME}
COPY --from=build_container ${UNPACK_ROOT}${SPARK_UNPACK_SUBPATH}/ ${SPARK_HOME}

